<div class="statistics-container">
  <div class="last-battle-panel">
    <div class="last-battle-controls">
      <select v-model="selectedCharacterId" class="character-select" :disabled="!characters.length">
        <option disabled value="">{{ $t('statistics.character.selectCharacter') }}</option>
        <option v-for="c in characters" :key="c.id" :value="c.id">{{ c.name }}</option>
      </select>
      <button class="last-battle-button" @click="fetchLastBattle" :disabled="!selectedCharacterId || loadingLastBattle || !characters.length">
        {{ loadingLastBattle ? $t('statistics.battle.searching') : $t('statistics.battle.lastBattle') }}
      </button>
    </div>
    <div class="last-battle-result" v-if="lastBattleResult">
      <template v-if="lastBattleResult.success && battleEntries.length">
        <div class="statistics-card battle-card">
          <div class="statistics-header battle-header">
            <h2>âš”ï¸ {{ $t('statistics.battle.lastBattleResults') }}</h2>
          </div>
          <div class="statistics-content battle-content">
            <div class="statistics-section">
              <div class="battle-grid">
                <div class="battle-grid-item" v-for="e in battleEntries" :key="e.path">
                  <div class="battle-grid-label">{{ e.path || '(raÃ­z)' }}</div>
                  <div class="battle-grid-value" :class="valueClass(e)">{{ formatEntryValue(e.value) }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </template>
      <div v-else class="battle-error-box">
        <h4>{{ $t('statistics.battle.error') }}</h4>
        <p>{{ lastBattleResult.error || $t('statistics.battle.unknownError') }}</p>
      </div>
    </div>
  </div>
  <div v-if="!character" class="no-character">
    <div class="no-character-icon">ğŸ“Š</div>
    <h3>{{ $t('statistics.title') }}</h3>
    <p>{{ $t('statistics.character.selectToView') }}</p>
  </div>
  <div v-else class="statistics-card">
    <div class="statistics-header">
      <h2>ğŸ“Š {{ $t('statistics.title') }}</h2>
      <div class="character-avatar-small">
        <img
          :src="character.avatar"
          :alt="character.name"
          @error="$event.target.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\'%3E%3Crect fill=\'%23ddd\' width=\'60\' height=\'60\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%23999\' font-family=\'Arial\' font-size=\'10\'%3E60x60%3C/text%3E%3C/svg%3E'"
        />
      </div>
    </div>

    <div class="statistics-content">
      <div class="statistics-section">
        <h3 class="section-title">âš”ï¸ {{ $t('statistics.character.generalInfo') }}</h3>
        <div class="stat-item">
          <span class="stat-label">{{ $t('character.name') }}:</span>
          <span class="stat-value-text">{{ character.name }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">{{ $t('character.race') }}:</span>
          <span class="stat-value-text">{{ character.race || $t('character.notSpecified') }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">{{ $t('character.class') }}:</span>
          <span class="stat-value-text">{{ character.class || $t('character.notSpecified') }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">{{ $t('character.guild') }}:</span>
          <span class="stat-value-text">{{ character.guild || $t('character.noGuild') }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">{{ $t('character.status') }}:</span>
          <span
            class="stat-value-text status-badge"
            :class="character.isOnline ? 'online' : 'offline'"
          >
            {{ character.isOnline ? 'ğŸŸ¢ ' + $t('character.online') : 'âš« ' + $t('character.offline') }}
          </span>
        </div>
      </div>

      <div class="statistics-section">
        <h3 class="section-title">ğŸ’ª {{ $t('statistics.character.attributes') }}</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-box-label">{{ $t('character.level') }}</div>
            <div class="stat-box-value level">{{ character.level || 1 }}</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-label">{{ $t('character.hp') }}</div>
            <div
              class="stat-box-value hp"
              :class="character.hp > 50 ? 'high' : character.hp > 20 ? 'medium' : 'low'"
            >
              {{ character.hp || 0 }}
            </div>
          </div>
          <div class="stat-box" v-if="character.shield !== undefined">
            <div class="stat-box-label">{{ $t('character.shield') }}</div>
            <div class="stat-box-value shield">{{ character.shield || 0 }}</div>
          </div>
        </div>
      </div>

      <div class="statistics-section" v-if="character.hp !== undefined">
        <h3 class="section-title">â¤ï¸ {{ $t('statistics.character.health') }}</h3>
        <div class="health-bar-container">
          <div class="health-bar-label">
            <span>{{ $t('character.life') }}: {{ character.hp || 0 }}%</span>
          </div>
          <div class="health-bar">
            <div
              class="health-bar-fill"
              :style="{ width: (character.hp || 0) + '%' }"
              :class="character.hp > 50 ? 'high' : character.hp > 20 ? 'medium' : 'low'"
            ></div>
          </div>
        </div>
        <div
          class="health-bar-container"
          v-if="character.shield !== undefined && character.shield > 0"
        >
          <div class="health-bar-label">
            <span>{{ $t('character.shield') }}: {{ character.shield }}%</span>
          </div>
          <div class="health-bar">
            <div
              class="health-bar-fill shield-bar"
              :style="{ width: character.shield + '%' }"
            ></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
